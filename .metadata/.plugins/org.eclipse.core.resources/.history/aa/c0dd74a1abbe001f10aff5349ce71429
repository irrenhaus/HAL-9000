#include <stddef.h>
#include <stdio.h>
#include <string.h>
#include "stm32f10x.h"
#include "stm32f10x_conf.h"
#include "util.h"
#include "config.h"
#include "screen.h"
#include "dbgMsg.h"
#include "ad7843.h"
#include "ui.h"
#include "lib/fat_sd/ffconf.h"
#include "lib/fat_sd/ff.h"
#include "lib/fat_sd/diskio.h"
#include "rotary.h"

#define F_CPU SystemCoreClock

/* REED Sensor & Touch handling */
int reed = 0;
u8 rotaryInWork = 0;
void EXTI15_10_IRQHandler(void) {
	static unsigned int lastOccured = 0;
	static u8 direction = 0;
	static unsigned int directionLastChange = 0;
	static u8 directionCount = 0;

	if (SysTickCounter - directionLastChange < 20) {
		direction = 0;
	}

	if (EXTI_GetITStatus(EXTI_Line15) != RESET) {
		if ((SysTickCounter - lastOccured) > 10) {
			lastOccured = SysTickCounter;
			reed++;
		}
		EXTI_ClearITPendingBit(EXTI_Line15);
	}
	//PENIRQ
	if (EXTI_GetITStatus(EXTI_Line10) != RESET) {

		EXTI_ClearITPendingBit(EXTI_Line10);
	}
	//DTASTER
	if (EXTI_GetITStatus(EXTI_Line13) != RESET) {
		enterPressed();
		toggle();
		EXTI_ClearITPendingBit(EXTI_Line13);
	}
	//DIN1
	if (EXTI_GetITStatus(EXTI_Line11) != RESET) {
		//Start timer for decoding rotary signal
		if(!rotaryInWork) {
		TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure;
		TIM_TimeBaseStructure.TIM_Period = (SystemCoreClock / 1000); //1 ms
		TIM_TimeBaseStructure.TIM_Prescaler = 0;
		TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1;
		TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Down;
		TIM_TimeBaseStructure.TIM_RepetitionCounter = 0;
		TIM_TimeBaseInit(TIM1, &TIM_TimeBaseStructure);

		  TIM_ClearFlag(TIM2, TIM_FLAG_Update);
		TIM_ITConfig(TIM1, TIM_IT_Update, ENABLE);
		  TIM_ClearFlag(TIM2, TIM_FLAG_Update);

		TIM_Cmd(TIM1, ENABLE);

		toggle();

		rotaryInWork = 1;
		}

		EXTI_ClearITPendingBit(EXTI_Line11);
	}
}

int main(void) {
	configureSystem();

	initDisplay();

	initUI();

	//Display Backlight on
	GPIO_WriteBit(GPIOA, GPIO_Pin_0, Bit_SET);

	/* Fat filesystem for the SD Card*/
	FATFS fatfs;

	if (f_mount(0, &fatfs) != FR_OK)
		sprintf(dbgMessage, "Mount failed");

	for (;;) {
		updateScreen();

		processUI();
	}

	return 0;
}

