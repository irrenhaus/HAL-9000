#include <stddef.h>
#include <stdio.h>
#include <string.h>
#include "stm32f10x.h"
#include "stm32f10x_conf.h"
#include "util.h"
#include "config.h"
#include "screen.h"
#include "dbgMsg.h"
#include "ad7843.h"
#include "ui.h"
#include "lib/fat_sd/ffconf.h"
#include "lib/fat_sd/ff.h"
#include "lib/fat_sd/diskio.h"
#include "rotary.h"

#define F_CPU SystemCoreClock

/* REED Sensor & Touch handling */
int reed = 0;
void EXTI15_10_IRQHandler(void) {
	static unsigned int lastOccured = 0;

	//reed
	if (EXTI_GetITStatus(EXTI_Line15) != RESET) {
		if ((SysTickCounter - lastOccured) > 10) {
			lastOccured = SysTickCounter;
			reed++;
		}
		EXTI_ClearITPendingBit(EXTI_Line15);
	}
	//PENIRQ
	if (EXTI_GetITStatus(EXTI_Line10) != RESET) {

		EXTI_ClearITPendingBit(EXTI_Line10);
	}
	//DTASTER
	if (EXTI_GetITStatus(EXTI_Line13) != RESET) {
		enterPressed();
		toggle();
		EXTI_ClearITPendingBit(EXTI_Line13);
	}
	//DIN1
	if (EXTI_GetITStatus(EXTI_Line11) != RESET) {
		u8 state = 0;
		u8 stateCount = 0;

		state = GPIO_ReadInputDataBit(GPIOD, GPIO_Pin_11);

		while (stateCount < 16) {
			if (GPIO_ReadInputDataBit(GPIOD, GPIO_Pin_11) == state)
				stateCount++;
			else
				stateCount = 0;
		}

		upPressed();

		toggle();
		EXTI_ClearITPendingBit(EXTI_Line11);
	}
	//DIN2
	if (EXTI_GetITStatus(EXTI_Line12) != RESET) {
		u8 state = 0;
		u8 stateCount = 0;

		state = GPIO_ReadInputDataBit(GPIOD, GPIO_Pin_12);

		while (stateCount < 8) {
			if (GPIO_ReadInputDataBit(GPIOD, GPIO_Pin_12) == state)
				stateCount++;
			else
				stateCount = 0;
		}

		downPressed();

		toggle();
		EXTI_ClearITPendingBit(EXTI_Line12);
	}
}

int main(void) {
	configureSystem();

	initDisplay();

	initUI();

	//Display Backlight on
	GPIO_WriteBit(GPIOA, GPIO_Pin_0, Bit_SET);

	/* Fat filesystem for the SD Card*/
	FATFS fatfs;

	if (f_mount(0, &fatfs) != FR_OK)
		sprintf(dbgMessage, "Mount failed");

	for (;;) {
		updateScreen();

		processUI();
	}

	return 0;
}

